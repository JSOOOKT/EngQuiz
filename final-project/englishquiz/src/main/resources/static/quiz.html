<script>
const user = getCurrentUser();
if (!user) window.location.href = 'login.html';

const urlParams = new URLSearchParams(window.location.search);
const questId = urlParams.get('questId');
if (!questId) { alert('No quest selected!'); window.location.href='index.html'; }

let questions = [];
let currentQuestionIndex = 0;
let score = 0;
let correctCount = 0;

// Load quiz questions
async function loadQuiz() {
    try {
        const quizzes = await getQuizzesByQuest(questId);
        if (quizzes.length === 0) { alert('No quizzes available!'); window.location.href='index.html'; return; }

        const quizId = quizzes[0].id;
        const allQuestions = await getQuestions();
        // Filter questions for this quiz
        questions = allQuestions.filter(q => q.quiz && q.quiz.id === quizId);

        if (questions.length === 0) { alert('No questions found!'); window.location.href='index.html'; return; }

        document.getElementById('totalQuestions').textContent = questions.length;
        displayQuestion();

    } catch (error) {
        console.error(error);
        alert('Failed to load quiz.');
        window.location.href='index.html';
    }
}

function displayQuestion() {
    if (currentQuestionIndex >= questions.length) { showResults(); return; }
    const question = questions[currentQuestionIndex];

    document.getElementById('currentQuestion').textContent = currentQuestionIndex+1;
    const progress = ((currentQuestionIndex+1)/questions.length)*100;
    document.getElementById('progressBar').style.width = progress + '%';

    document.getElementById('questionText').textContent = question.questionText;

    const optionsContainer = document.getElementById('optionsContainer');
    optionsContainer.innerHTML = '';

    // Map backend options to A/B/C/D dynamically
    ['optionA','optionB','optionC','optionD'].forEach(key=>{
        if(question[key]){
            const button = document.createElement('button');
            button.className='option-btn';
            button.innerHTML=`<strong>${key.slice(-1)}</strong>. ${question[key]}`;
            button.onclick = () => checkAnswer(key.slice(-1), question.correctAnswer);
            optionsContainer.appendChild(button);
        }
    });

    document.getElementById('feedbackBox').classList.add('d-none');
    document.getElementById('nextBtn').classList.add('d-none');
}

function checkAnswer(selectedOption, correctAnswer){
    const feedbackBox = document.getElementById('feedbackBox');
    const optionButtons = document.querySelectorAll('.option-btn');
    optionButtons.forEach(btn => btn.disabled = true);

    const isCorrect = selectedOption === correctAnswer.toUpperCase() || 
          questions[currentQuestionIndex][`option${selectedOption}`] === correctAnswer;

    if(isCorrect){
        score += 10;
        correctCount++;
        feedbackBox.className='alert alert-success mt-4';
        feedbackBox.innerHTML='✓ Correct!';
        optionButtons.forEach(btn => { if(btn.innerHTML.includes(selectedOption)) btn.classList.add('correct'); });
    } else {
        feedbackBox.className='alert alert-danger mt-4';
        feedbackBox.innerHTML=`✗ Incorrect! Correct: ${correctAnswer}`;
        optionButtons.forEach(btn=>{
            if(btn.innerHTML.includes(selectedOption)) btn.classList.add('incorrect');
            if(btn.innerHTML.includes(correctAnswer)) btn.classList.add('correct');
        });
    }

    document.getElementById('currentScore').textContent = score;
    feedbackBox.classList.remove('d-none');
    document.getElementById('nextBtn').classList.remove('d-none');
}

document.getElementById('nextBtn').addEventListener('click', ()=>{
    currentQuestionIndex++;
    displayQuestion();
});

async function showResults(){
    document.getElementById('questionCard').classList.add('d-none');
    document.getElementById('resultsCard').classList.remove('d-none');
    document.getElementById('finalScore').textContent = score;
    document.getElementById('correctAnswers').textContent = `${correctCount} / ${questions.length}`;

    // Save score to backend
    await saveUserScore(user.id, score);
}

loadQuiz();
</script>
